using ComplianceService.Domain.Shared;

namespace ComplianceService.Domain.Evaluation.ValueObjects;

/// <summary>
/// Represents a security vulnerability found by a scanning tool
/// </summary>
public sealed class Vulnerability : ValueObject
{
    public string Id { get; }
    public string Title { get; }
    public VulnerabilitySeverity Severity { get; }
    public double CvssScore { get; }
    public string PackageName { get; }
    public string PackageVersion { get; }
    public string? FixedIn { get; }
    public List<string> Cve { get; }
    public List<string> Cwe { get; }

    private Vulnerability(
        string id,
        string title,
        VulnerabilitySeverity severity,
        double cvssScore,
        string packageName,
        string packageVersion,
        string? fixedIn,
        List<string> cve,
        List<string> cwe)
    {
        Id = id;
        Title = title;
        Severity = severity;
        CvssScore = cvssScore;
        PackageName = packageName;
        PackageVersion = packageVersion;
        FixedIn = fixedIn;
        Cve = cve;
        Cwe = cwe;
    }

    public static Result<Vulnerability> Create(
        string id,
        string title,
        string severity,
        double cvssScore,
        string packageName,
        string packageVersion,
        string? fixedIn = null,
        List<string>? cve = null,
        List<string>? cwe = null)
    {
        if (string.IsNullOrWhiteSpace(id))
            return Result.Failure<Vulnerability>("Vulnerability ID cannot be empty");

        if (string.IsNullOrWhiteSpace(title))
            return Result.Failure<Vulnerability>("Vulnerability title cannot be empty");

        var severityResult = VulnerabilitySeverity.Create(severity);
        if (severityResult.IsFailure)
            return Result.Failure<Vulnerability>(severityResult.Error);

        if (cvssScore < 0 || cvssScore > 10)
            return Result.Failure<Vulnerability>("CVSS score must be between 0 and 10");

        if (string.IsNullOrWhiteSpace(packageName))
            return Result.Failure<Vulnerability>("Package name cannot be empty");

        if (string.IsNullOrWhiteSpace(packageVersion))
            return Result.Failure<Vulnerability>("Package version cannot be empty");

        return Result.Success(new Vulnerability(
            id.Trim(),
            title.Trim(),
            severityResult.Value,
            cvssScore,
            packageName.Trim(),
            packageVersion.Trim(),
            fixedIn?.Trim(),
            cve ?? new List<string>(),
            cwe ?? new List<string>()));
    }

    public bool IsCritical => Severity.IsCritical;
    public bool IsHighOrAbove => Severity.IsHighOrAbove;

    protected override IEnumerable<object?> GetEqualityComponents()
    {
        yield return Id;
        yield return PackageName;
        yield return PackageVersion;
    }
}

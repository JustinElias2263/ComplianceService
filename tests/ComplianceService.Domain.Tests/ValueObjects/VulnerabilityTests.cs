using ComplianceService.Domain.Evaluation.ValueObjects;
using FluentAssertions;
using Xunit;

namespace ComplianceService.Domain.Tests.ValueObjects;

public class VulnerabilityTests
{
    [Fact]
    public void Create_WithValidData_ShouldSucceed()
    {
        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: "SQL Injection vulnerability",
            severity: "critical",
            cvssScore: 9.8,
            packageName: "example-package",
            packageVersion: "1.0.0");

        // Assert
        result.IsSuccess.Should().BeTrue();
        result.Value.Id.Should().Be("SNYK-001");
        result.Value.Title.Should().Be("SQL Injection vulnerability");
        result.Value.Severity.Value.Should().Be("critical");
        result.Value.CvssScore.Should().Be(9.8);
        result.Value.PackageName.Should().Be("example-package");
        result.Value.PackageVersion.Should().Be("1.0.0");
        result.Value.FixedIn.Should().BeNull();
        result.Value.Cve.Should().BeEmpty();
        result.Value.Cwe.Should().BeEmpty();
    }

    [Fact]
    public void Create_WithOptionalFields_ShouldSucceed()
    {
        // Arrange
        var cveList = new List<string> { "CVE-2023-1234", "CVE-2023-5678" };
        var cweList = new List<string> { "CWE-89", "CWE-79" };

        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: "XSS vulnerability",
            severity: "high",
            cvssScore: 7.5,
            packageName: "example-package",
            packageVersion: "1.0.0",
            fixedIn: "1.0.1",
            cve: cveList,
            cwe: cweList);

        // Assert
        result.IsSuccess.Should().BeTrue();
        result.Value.FixedIn.Should().Be("1.0.1");
        result.Value.Cve.Should().BeEquivalentTo(cveList);
        result.Value.Cwe.Should().BeEquivalentTo(cweList);
    }

    [Fact]
    public void Create_ShouldTrimWhitespace()
    {
        // Act
        var result = Vulnerability.Create(
            id: "  SNYK-001  ",
            title: "  SQL Injection  ",
            severity: "critical",
            cvssScore: 9.8,
            packageName: "  example-package  ",
            packageVersion: "  1.0.0  ",
            fixedIn: "  1.0.1  ");

        // Assert
        result.IsSuccess.Should().BeTrue();
        result.Value.Id.Should().Be("SNYK-001");
        result.Value.Title.Should().Be("SQL Injection");
        result.Value.PackageName.Should().Be("example-package");
        result.Value.PackageVersion.Should().Be("1.0.0");
        result.Value.FixedIn.Should().Be("1.0.1");
    }

    [Theory]
    [InlineData("")]
    [InlineData("  ")]
    [InlineData(null)]
    public void Create_WithInvalidId_ShouldFail(string invalidId)
    {
        // Act
        var result = Vulnerability.Create(
            id: invalidId,
            title: "SQL Injection",
            severity: "critical",
            cvssScore: 9.8,
            packageName: "example-package",
            packageVersion: "1.0.0");

        // Assert
        result.IsFailure.Should().BeTrue();
        result.Error.Should().Contain("ID cannot be empty");
    }

    [Theory]
    [InlineData("")]
    [InlineData("  ")]
    [InlineData(null)]
    public void Create_WithInvalidTitle_ShouldFail(string invalidTitle)
    {
        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: invalidTitle,
            severity: "critical",
            cvssScore: 9.8,
            packageName: "example-package",
            packageVersion: "1.0.0");

        // Assert
        result.IsFailure.Should().BeTrue();
        result.Error.Should().Contain("title cannot be empty");
    }

    [Theory]
    [InlineData("invalid")]
    [InlineData("")]
    [InlineData(null)]
    public void Create_WithInvalidSeverity_ShouldFail(string invalidSeverity)
    {
        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: "SQL Injection",
            severity: invalidSeverity,
            cvssScore: 9.8,
            packageName: "example-package",
            packageVersion: "1.0.0");

        // Assert
        result.IsFailure.Should().BeTrue();
    }

    [Theory]
    [InlineData(-1.0)]
    [InlineData(10.1)]
    [InlineData(100.0)]
    public void Create_WithInvalidCvssScore_ShouldFail(double invalidScore)
    {
        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: "SQL Injection",
            severity: "critical",
            cvssScore: invalidScore,
            packageName: "example-package",
            packageVersion: "1.0.0");

        // Assert
        result.IsFailure.Should().BeTrue();
        result.Error.Should().Contain("CVSS score must be between 0 and 10");
    }

    [Theory]
    [InlineData("")]
    [InlineData("  ")]
    [InlineData(null)]
    public void Create_WithInvalidPackageName_ShouldFail(string invalidPackage)
    {
        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: "SQL Injection",
            severity: "critical",
            cvssScore: 9.8,
            packageName: invalidPackage,
            packageVersion: "1.0.0");

        // Assert
        result.IsFailure.Should().BeTrue();
        result.Error.Should().Contain("Package name cannot be empty");
    }

    [Theory]
    [InlineData("")]
    [InlineData("  ")]
    [InlineData(null)]
    public void Create_WithInvalidPackageVersion_ShouldFail(string invalidVersion)
    {
        // Act
        var result = Vulnerability.Create(
            id: "SNYK-001",
            title: "SQL Injection",
            severity: "critical",
            cvssScore: 9.8,
            packageName: "example-package",
            packageVersion: invalidVersion);

        // Assert
        result.IsFailure.Should().BeTrue();
        result.Error.Should().Contain("Package version cannot be empty");
    }

    [Fact]
    public void IsCritical_WhenCriticalSeverity_ShouldBeTrue()
    {
        // Arrange
        var vuln = Vulnerability.Create(
            "SNYK-001", "SQL Injection", "critical", 9.8,
            "example-package", "1.0.0").Value;

        // Assert
        vuln.IsCritical.Should().BeTrue();
    }

    [Theory]
    [InlineData("high")]
    [InlineData("medium")]
    [InlineData("low")]
    public void IsCritical_WhenNotCritical_ShouldBeFalse(string severity)
    {
        // Arrange
        var vuln = Vulnerability.Create(
            "SNYK-001", "Issue", severity, 5.0,
            "example-package", "1.0.0").Value;

        // Assert
        vuln.IsCritical.Should().BeFalse();
    }

    [Theory]
    [InlineData("critical")]
    [InlineData("high")]
    public void IsHighOrAbove_WhenHighOrCritical_ShouldBeTrue(string severity)
    {
        // Arrange
        var vuln = Vulnerability.Create(
            "SNYK-001", "Issue", severity, 7.0,
            "example-package", "1.0.0").Value;

        // Assert
        vuln.IsHighOrAbove.Should().BeTrue();
    }

    [Theory]
    [InlineData("medium")]
    [InlineData("low")]
    public void IsHighOrAbove_WhenBelowHigh_ShouldBeFalse(string severity)
    {
        // Arrange
        var vuln = Vulnerability.Create(
            "SNYK-001", "Issue", severity, 3.0,
            "example-package", "1.0.0").Value;

        // Assert
        vuln.IsHighOrAbove.Should().BeFalse();
    }

    [Fact]
    public void Equality_WithSameIdAndPackage_ShouldBeEqual()
    {
        // Arrange
        var vuln1 = Vulnerability.Create(
            "SNYK-001", "SQL Injection", "critical", 9.8,
            "example-package", "1.0.0").Value;
        var vuln2 = Vulnerability.Create(
            "SNYK-001", "SQL Injection", "critical", 9.8,
            "example-package", "1.0.0").Value;

        // Assert
        vuln1.Should().Be(vuln2);
    }

    [Fact]
    public void Equality_WithDifferentId_ShouldNotBeEqual()
    {
        // Arrange
        var vuln1 = Vulnerability.Create(
            "SNYK-001", "SQL Injection", "critical", 9.8,
            "example-package", "1.0.0").Value;
        var vuln2 = Vulnerability.Create(
            "SNYK-002", "SQL Injection", "critical", 9.8,
            "example-package", "1.0.0").Value;

        // Assert
        vuln1.Should().NotBe(vuln2);
    }
}
